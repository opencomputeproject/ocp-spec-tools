# Reusable workflow to render the spec for a variety of purposes.
# https://docs.github.com/en/actions/using-workflows/reusing-workflows

name: render

on:
  workflow_call:
    inputs:
      container:
        description: the Docker container to use (default is trustedcomputinggroup/pandoc)
        required: false
        type: string
        default: ghcr.io/trustedcomputinggroup/pandoc
      tcg-container-version:
        description: the released version of the Docker container to use
        required: true
        type: string
      ocp-template-ref:
        description: Git branch, tag or SHA for opencomputeproject/ocp-spec-tools template resources
        required: true
        type: string
      input:
        description: the Markdown file to render
        required: true
        type: string
      pdf:
        description: 'Render to PDF'
        required: false
        type: boolean
        default: false
      html:
        description: 'Render to HTML'
        required: false
        type: boolean
        default: false

jobs:
  render:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.container }}:${{ inputs.tcg-container-version }}
    name: Render
    steps:
      # Use the input file name (no extension) as the base filename for the output
      - name: Calculate output file name
        id: gen_output_name
        run: |
          filename=$(basename ${{ inputs.input }})
          filename="${filename%.*}"
          echo OUTPUT_FILENAME="${filename}" >> "$GITHUB_OUTPUT"
          echo output filename: ${filename}

      - name: Checkout inputs
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.revision }}
          fetch-depth: 0
          fetch-tags: true

      - name: Checkout OCP template resources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          repository: "opencomputeproject/ocp-spec-tools"
          ref: ${{ inputs.ocp-template-ref }}
          # The underlying tex and templates assume this exists under the "extra" folder.
          path: "extra"

      # Use input file and container version in the cache key so that the cache
      # is invalidated upon file change or container version change.
      - name: Restore cached files
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .cache/**/*
          key: cache-${{ inputs.input }}-${{ inputs.tcg-container-version }}-${{ inputs.ocp-template-ref }}-${{ github.run_id }}
          restore-keys: cache-${{ inputs.input }}-${{ inputs.tcg-container-version }}-${{ inputs.ocp-template-ref }}

      # Let the container take ownership of the repo dir, in case the user wants to check in the results.
      # Workaround to https://github.com/actions/runner/issues/2033
      - run: chown -R $(id -u):$(id -g) $PWD
        shell: sh

      # Perform the render.
      - run: >
          /usr/bin/build.sh
          --nogitversion
          --crossref=tcg
          --csl extra/ocp-pandoc-resources/ieee.csl
          --template extra/ocp-pandoc-resources/pdf/ocp.tex
          --template_html extra/ocp-pandoc-resources/html/ocp.html.template
          --html_stylesheet extra/ocp-pandoc-resources/html/style.css
          $( ${{ inputs.pdf }}  && echo --pdf=${{ steps.gen_output_name.outputs.OUTPUT_FILENAME }}.pdf )
          $( ${{ inputs.html }} && echo --html=${{ steps.gen_output_name.outputs.OUTPUT_FILENAME }}.html )
          ${{ inputs.input }}
        shell: sh

      - name: Save cached files
        id: cache-save
        uses: actions/cache/save@v4
        with:
          path: .cache/**/*
          key: cache-${{ inputs.input }}-${{ inputs.tcg-container-version }}-${{ inputs.ocp-template-ref }}-${{ github.run_id }}

      # Upload all workflow artifacts
      - name: Upload PDF artifact
        if: ${{ inputs.pdf == true }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.gen_output_name.outputs.OUTPUT_FILENAME }}.pdf
          path: |
            ${{ steps.gen_output_name.outputs.OUTPUT_FILENAME }}*.pdf
      - name: Upload HTML artifact
        if: ${{ inputs.html == true }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.gen_output_name.outputs.OUTPUT_FILENAME }}.html
          path: |
            ${{ steps.gen_output_name.outputs.OUTPUT_FILENAME }}*.html
